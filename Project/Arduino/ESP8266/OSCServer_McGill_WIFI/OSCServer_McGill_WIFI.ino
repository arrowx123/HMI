/*---------------------------------------------------------------------------------------------

  Open Sound Control (OSC) library for the ESP8266
  Example for sending messages from the ESP8266 to a remote computer
  This example code is in the public domain.

--------------------------------------------------------------------------------------------- */

extern "C" {
#include "user_interface.h"
#include "Esp.h"
}

#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <OSCMessage.h>

// The parameter of the wifi connection
//const int size = 1010;
char *ssid;
char *pass;
unsigned char identity[] = "guofan.yin@mail.mcgill.ca";

String requests[] = {"setLedValue", "setOSCIP",
                     "setOSCRemotePort", "setOSCLocalPort",
                     "showSetting", "McGillWiFi", "srlWiFi"};


char OSCIP_char[20];
char msgChar[100];
String OSCIP = "10.0.0.101";
char addressPattern[] = "/test";

// Air Intensity Level 0 ~ 3
int airIntensityLevelNum = 4;
int airIntensity = -1;
int pwmValue[] = {255, 511, 767, 1023};

// Rotation direction
int rotationDirectionNum = 2;
int rotationDirection = -1;

// The arrangement of GPIOs in the righttop corner of NodeMCU
const int trigger_drillBitControl = 4;    //yellow:   "p"         D2
const int rotationDirectionControl = 5;    //white:    "q"         D1

const int led = 16;   //drive internal led    D0
const int motor = 9;    //drive motor           SD2

// Air regulator
const int airRegulator_0 = 0;    //D3
const int airRegulator_1 = 2;    //D4
const int airRegulator_2 = 14;   //D5
const int airRegulator_3 = 12;   //D6

int ledValue = 1;
int initialMotorValue = 0;

int OSCLocalPort = 9999;
int OSCRemotePort = 8888;
int serverListenPort = 80;


WiFiUDP Udp;                                  // A UDP instance to let us send and receive packets over UDP
WiFiServer server(serverListenPort);          // Create an instance of the server specify the port to listen on

const IPAddress outIp(172, 18, 63, 37);       // remote IP of your computer
//const IPAddress outIp(10,40,10,105);        // remote IP of your computer

//const unsigned int outPort = 9999;          // remote port to receive OSC
//const unsigned int localPort = 8888;        // local port to listen for OSC packets (actually not used for sending)

bool useEAPInit = false;


uint8 espclientCrt[] = {
        0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x42, 0x45, 0x47, 0x49, 0x4e, 0x20, 0x43,
        0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x2d, 0x2d,
        0x2d, 0x2d, 0x2d, 0x0a, 0x4d, 0x49, 0x49, 0x44, 0x51, 0x6a, 0x43, 0x43,
        0x41, 0x69, 0x71, 0x67, 0x41, 0x77, 0x49, 0x42, 0x41, 0x67, 0x49, 0x42,
        0x42, 0x44, 0x41, 0x4e, 0x42, 0x67, 0x6b, 0x71, 0x68, 0x6b, 0x69, 0x47,
        0x39, 0x77, 0x30, 0x42, 0x41, 0x51, 0x73, 0x46, 0x41, 0x44, 0x41, 0x59,
        0x4d, 0x52, 0x59, 0x77, 0x46, 0x41, 0x59, 0x44, 0x56, 0x51, 0x51, 0x44,
        0x44, 0x41, 0x31, 0x74, 0x63, 0x58, 0x52, 0x30, 0x0a, 0x63, 0x32, 0x56,
        0x79, 0x64, 0x6d, 0x56, 0x79, 0x49, 0x45, 0x4e, 0x42, 0x4d, 0x42, 0x34,
        0x58, 0x44, 0x54, 0x45, 0x32, 0x4d, 0x44, 0x45, 0x78, 0x4f, 0x54, 0x45,
        0x35, 0x4d, 0x7a, 0x6b, 0x78, 0x4f, 0x46, 0x6f, 0x58, 0x44, 0x54, 0x49,
        0x32, 0x4d, 0x44, 0x45, 0x78, 0x4e, 0x6a, 0x45, 0x35, 0x4d, 0x7a, 0x6b,
        0x78, 0x4f, 0x46, 0x6f, 0x77, 0x46, 0x54, 0x45, 0x54, 0x4d, 0x42, 0x45,
        0x47, 0x0a, 0x41, 0x31, 0x55, 0x45, 0x41, 0x77, 0x77, 0x4b, 0x5a, 0x58,
        0x4e, 0x77, 0x59, 0x32, 0x78, 0x70, 0x5a, 0x57, 0x35, 0x30, 0x4d, 0x54,
        0x43, 0x43, 0x41, 0x53, 0x49, 0x77, 0x44, 0x51, 0x59, 0x4a, 0x4b, 0x6f,
        0x5a, 0x49, 0x68, 0x76, 0x63, 0x4e, 0x41, 0x51, 0x45, 0x42, 0x42, 0x51,
        0x41, 0x44, 0x67, 0x67, 0x45, 0x50, 0x41, 0x44, 0x43, 0x43, 0x41, 0x51,
        0x6f, 0x43, 0x67, 0x67, 0x45, 0x42, 0x0a, 0x41, 0x4f, 0x64, 0x39, 0x48,
        0x63, 0x4d, 0x32, 0x53, 0x73, 0x36, 0x4c, 0x4b, 0x2b, 0x68, 0x41, 0x34,
        0x4f, 0x4d, 0x43, 0x66, 0x47, 0x6d, 0x42, 0x68, 0x48, 0x57, 0x73, 0x71,
        0x59, 0x73, 0x4b, 0x6e, 0x2f, 0x30, 0x45, 0x36, 0x79, 0x64, 0x43, 0x4c,
        0x43, 0x78, 0x47, 0x57, 0x70, 0x72, 0x58, 0x76, 0x64, 0x78, 0x38, 0x4a,
        0x42, 0x31, 0x53, 0x50, 0x35, 0x34, 0x67, 0x55, 0x30, 0x57, 0x47, 0x0a,
        0x74, 0x4a, 0x39, 0x2f, 0x37, 0x57, 0x41, 0x75, 0x46, 0x77, 0x35, 0x66,
        0x56, 0x51, 0x61, 0x7a, 0x2f, 0x47, 0x48, 0x48, 0x4a, 0x4e, 0x6a, 0x63,
        0x2b, 0x44, 0x64, 0x44, 0x4c, 0x43, 0x63, 0x67, 0x4d, 0x46, 0x72, 0x72,
        0x31, 0x33, 0x37, 0x69, 0x7a, 0x78, 0x66, 0x41, 0x7a, 0x44, 0x43, 0x46,
        0x2b, 0x76, 0x34, 0x65, 0x53, 0x78, 0x4d, 0x42, 0x42, 0x4a, 0x42, 0x50,
        0x70, 0x36, 0x6c, 0x5a, 0x0a, 0x33, 0x43, 0x48, 0x64, 0x47, 0x46, 0x58,
        0x2f, 0x66, 0x30, 0x42, 0x6f, 0x6c, 0x34, 0x72, 0x32, 0x73, 0x78, 0x39,
        0x75, 0x6d, 0x71, 0x31, 0x68, 0x70, 0x49, 0x47, 0x63, 0x49, 0x38, 0x50,
        0x69, 0x4a, 0x52, 0x54, 0x46, 0x66, 0x69, 0x55, 0x76, 0x35, 0x6e, 0x62,
        0x6f, 0x53, 0x70, 0x59, 0x77, 0x57, 0x4b, 0x45, 0x55, 0x64, 0x67, 0x65,
        0x4e, 0x52, 0x56, 0x45, 0x30, 0x46, 0x64, 0x45, 0x61, 0x0a, 0x33, 0x4b,
        0x41, 0x62, 0x32, 0x4e, 0x7a, 0x64, 0x32, 0x6f, 0x6f, 0x2b, 0x2b, 0x55,
        0x34, 0x4f, 0x37, 0x4b, 0x53, 0x69, 0x53, 0x35, 0x57, 0x36, 0x62, 0x67,
        0x50, 0x6e, 0x7a, 0x48, 0x4d, 0x64, 0x64, 0x64, 0x54, 0x4d, 0x38, 0x57,
        0x64, 0x64, 0x39, 0x7a, 0x35, 0x51, 0x6d, 0x43, 0x2b, 0x39, 0x5a, 0x5a,
        0x49, 0x38, 0x57, 0x65, 0x42, 0x35, 0x45, 0x33, 0x61, 0x44, 0x52, 0x59,
        0x4c, 0x67, 0x0a, 0x2b, 0x39, 0x48, 0x33, 0x64, 0x53, 0x44, 0x34, 0x59,
        0x48, 0x72, 0x49, 0x48, 0x79, 0x4c, 0x4b, 0x6f, 0x39, 0x71, 0x52, 0x68,
        0x6d, 0x63, 0x2b, 0x70, 0x54, 0x4a, 0x6d, 0x33, 0x43, 0x56, 0x54, 0x70,
        0x64, 0x66, 0x2f, 0x52, 0x48, 0x6b, 0x36, 0x67, 0x6b, 0x30, 0x69, 0x6c,
        0x43, 0x53, 0x2b, 0x51, 0x77, 0x56, 0x51, 0x31, 0x58, 0x45, 0x69, 0x45,
        0x68, 0x73, 0x7a, 0x30, 0x32, 0x44, 0x6f, 0x0a, 0x4a, 0x77, 0x65, 0x4a,
        0x2b, 0x71, 0x54, 0x79, 0x75, 0x46, 0x71, 0x33, 0x55, 0x34, 0x45, 0x64,
        0x33, 0x5a, 0x5a, 0x50, 0x76, 0x61, 0x63, 0x43, 0x41, 0x77, 0x45, 0x41,
        0x41, 0x61, 0x4f, 0x42, 0x6d, 0x54, 0x43, 0x42, 0x6c, 0x6a, 0x41, 0x4a,
        0x42, 0x67, 0x4e, 0x56, 0x48, 0x52, 0x4d, 0x45, 0x41, 0x6a, 0x41, 0x41,
        0x4d, 0x42, 0x30, 0x47, 0x41, 0x31, 0x55, 0x64, 0x44, 0x67, 0x51, 0x57,
        0x0a, 0x42, 0x42, 0x52, 0x76, 0x39, 0x51, 0x75, 0x37, 0x32, 0x76, 0x50,
        0x71, 0x42, 0x78, 0x41, 0x35, 0x5a, 0x42, 0x57, 0x2b, 0x78, 0x77, 0x34,
        0x56, 0x50, 0x43, 0x57, 0x30, 0x49, 0x6a, 0x42, 0x49, 0x42, 0x67, 0x4e,
        0x56, 0x48, 0x53, 0x4d, 0x45, 0x51, 0x54, 0x41, 0x2f, 0x67, 0x42, 0x53,
        0x78, 0x6b, 0x54, 0x48, 0x31, 0x77, 0x4d, 0x70, 0x6f, 0x6d, 0x37, 0x56,
        0x79, 0x65, 0x73, 0x64, 0x62, 0x0a, 0x7a, 0x70, 0x7a, 0x62, 0x54, 0x35,
        0x58, 0x74, 0x55, 0x71, 0x45, 0x63, 0x70, 0x42, 0x6f, 0x77, 0x47, 0x44,
        0x45, 0x57, 0x4d, 0x42, 0x51, 0x47, 0x41, 0x31, 0x55, 0x45, 0x41, 0x77,
        0x77, 0x4e, 0x62, 0x58, 0x46, 0x30, 0x64, 0x48, 0x4e, 0x6c, 0x63, 0x6e,
        0x5a, 0x6c, 0x63, 0x69, 0x42, 0x44, 0x51, 0x59, 0x49, 0x4a, 0x41, 0x4a,
        0x64, 0x34, 0x4c, 0x2f, 0x76, 0x6f, 0x4a, 0x36, 0x4d, 0x55, 0x0a, 0x4d,
        0x42, 0x4d, 0x47, 0x41, 0x31, 0x55, 0x64, 0x4a, 0x51, 0x51, 0x4d, 0x4d,
        0x41, 0x6f, 0x47, 0x43, 0x43, 0x73, 0x47, 0x41, 0x51, 0x55, 0x46, 0x42,
        0x77, 0x4d, 0x43, 0x4d, 0x41, 0x73, 0x47, 0x41, 0x31, 0x55, 0x64, 0x44,
        0x77, 0x51, 0x45, 0x41, 0x77, 0x49, 0x48, 0x67, 0x44, 0x41, 0x4e, 0x42,
        0x67, 0x6b, 0x71, 0x68, 0x6b, 0x69, 0x47, 0x39, 0x77, 0x30, 0x42, 0x41,
        0x51, 0x73, 0x46, 0x0a, 0x41, 0x41, 0x4f, 0x43, 0x41, 0x51, 0x45, 0x41,
        0x44, 0x50, 0x47, 0x4e, 0x31, 0x62, 0x4c, 0x57, 0x45, 0x49, 0x35, 0x4a,
        0x35, 0x6d, 0x4d, 0x31, 0x61, 0x54, 0x4c, 0x64, 0x38, 0x63, 0x50, 0x76,
        0x49, 0x62, 0x4e, 0x4f, 0x72, 0x6c, 0x63, 0x4c, 0x36, 0x70, 0x64, 0x62,
        0x48, 0x63, 0x2b, 0x52, 0x69, 0x71, 0x42, 0x71, 0x33, 0x61, 0x64, 0x61,
        0x74, 0x56, 0x5a, 0x71, 0x2f, 0x38, 0x76, 0x62, 0x0a, 0x73, 0x50, 0x43,
        0x64, 0x71, 0x49, 0x7a, 0x30, 0x58, 0x47, 0x30, 0x37, 0x65, 0x50, 0x51,
        0x77, 0x59, 0x51, 0x7a, 0x64, 0x63, 0x4f, 0x77, 0x67, 0x64, 0x7a, 0x78,
        0x4a, 0x73, 0x76, 0x4e, 0x42, 0x47, 0x62, 0x77, 0x36, 0x47, 0x4a, 0x6d,
        0x36, 0x32, 0x6c, 0x70, 0x52, 0x42, 0x2b, 0x62, 0x41, 0x30, 0x76, 0x79,
        0x2b, 0x71, 0x67, 0x6e, 0x34, 0x32, 0x6c, 0x78, 0x32, 0x57, 0x56, 0x4b,
        0x4d, 0x0a, 0x66, 0x53, 0x68, 0x68, 0x43, 0x59, 0x61, 0x71, 0x59, 0x52,
        0x46, 0x5a, 0x72, 0x4a, 0x52, 0x66, 0x2b, 0x79, 0x58, 0x65, 0x61, 0x74,
        0x58, 0x74, 0x64, 0x4a, 0x4d, 0x69, 0x75, 0x5a, 0x6f, 0x64, 0x55, 0x52,
        0x36, 0x70, 0x32, 0x68, 0x35, 0x6b, 0x42, 0x52, 0x6c, 0x45, 0x34, 0x62,
        0x72, 0x6d, 0x73, 0x66, 0x5a, 0x71, 0x33, 0x44, 0x4e, 0x53, 0x34, 0x33,
        0x6e, 0x65, 0x2f, 0x72, 0x6f, 0x49, 0x0a, 0x31, 0x2f, 0x66, 0x76, 0x43,
        0x31, 0x45, 0x51, 0x6f, 0x79, 0x5a, 0x71, 0x2b, 0x6f, 0x44, 0x32, 0x4e,
        0x4a, 0x53, 0x2f, 0x38, 0x4f, 0x64, 0x58, 0x52, 0x58, 0x43, 0x36, 0x43,
        0x32, 0x56, 0x69, 0x6d, 0x51, 0x62, 0x4e, 0x69, 0x67, 0x75, 0x42, 0x71,
        0x73, 0x71, 0x35, 0x32, 0x36, 0x4d, 0x71, 0x31, 0x7a, 0x37, 0x57, 0x31,
        0x6f, 0x50, 0x7a, 0x66, 0x5a, 0x75, 0x61, 0x30, 0x61, 0x4c, 0x6e, 0x0a,
        0x64, 0x6f, 0x53, 0x63, 0x67, 0x44, 0x52, 0x4a, 0x69, 0x65, 0x37, 0x65,
        0x69, 0x77, 0x52, 0x33, 0x74, 0x46, 0x66, 0x49, 0x66, 0x74, 0x32, 0x4a,
        0x4a, 0x44, 0x55, 0x6e, 0x6d, 0x55, 0x6c, 0x57, 0x39, 0x46, 0x2b, 0x54,
        0x74, 0x55, 0x48, 0x6d, 0x73, 0x76, 0x78, 0x4e, 0x50, 0x30, 0x58, 0x31,
        0x57, 0x68, 0x53, 0x36, 0x36, 0x70, 0x66, 0x64, 0x43, 0x45, 0x61, 0x6a,
        0x47, 0x59, 0x6c, 0x42, 0x0a, 0x6b, 0x33, 0x78, 0x57, 0x4b, 0x74, 0x6f,
        0x32, 0x78, 0x4c, 0x45, 0x65, 0x69, 0x71, 0x71, 0x72, 0x31, 0x32, 0x64,
        0x39, 0x64, 0x66, 0x34, 0x52, 0x52, 0x2b, 0x2b, 0x52, 0x6f, 0x77, 0x3d,
        0x3d, 0x0a, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x45, 0x4e, 0x44, 0x20, 0x43,
        0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x2d, 0x2d,
        0x2d, 0x2d, 0x2d, 0x0a, 0x00
};

uint8 espclientKey[] = {
        0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x42, 0x45, 0x47, 0x49, 0x4e, 0x20, 0x50,
        0x52, 0x49, 0x56, 0x41, 0x54, 0x45, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d,
        0x2d, 0x2d, 0x2d, 0x0a, 0x4d, 0x49, 0x49, 0x45, 0x76, 0x67, 0x49, 0x42,
        0x41, 0x44, 0x41, 0x4e, 0x42, 0x67, 0x6b, 0x71, 0x68, 0x6b, 0x69, 0x47,
        0x39, 0x77, 0x30, 0x42, 0x41, 0x51, 0x45, 0x46, 0x41, 0x41, 0x53, 0x43,
        0x42, 0x4b, 0x67, 0x77, 0x67, 0x67, 0x53, 0x6b, 0x41, 0x67, 0x45, 0x41,
        0x41, 0x6f, 0x49, 0x42, 0x41, 0x51, 0x44, 0x6e, 0x66, 0x52, 0x33, 0x44,
        0x4e, 0x6b, 0x72, 0x4f, 0x69, 0x79, 0x76, 0x6f, 0x0a, 0x51, 0x4f, 0x44,
        0x6a, 0x41, 0x6e, 0x78, 0x70, 0x67, 0x59, 0x52, 0x31, 0x72, 0x4b, 0x6d,
        0x4c, 0x43, 0x70, 0x2f, 0x39, 0x42, 0x4f, 0x73, 0x6e, 0x51, 0x69, 0x77,
        0x73, 0x52, 0x6c, 0x71, 0x61, 0x31, 0x37, 0x33, 0x63, 0x66, 0x43, 0x51,
        0x64, 0x55, 0x6a, 0x2b, 0x65, 0x49, 0x46, 0x4e, 0x46, 0x68, 0x72, 0x53,
        0x66, 0x66, 0x2b, 0x31, 0x67, 0x4c, 0x68, 0x63, 0x4f, 0x58, 0x31, 0x55,
        0x47, 0x0a, 0x73, 0x2f, 0x78, 0x68, 0x78, 0x79, 0x54, 0x59, 0x33, 0x50,
        0x67, 0x33, 0x51, 0x79, 0x77, 0x6e, 0x49, 0x44, 0x42, 0x61, 0x36, 0x39,
        0x64, 0x2b, 0x34, 0x73, 0x38, 0x58, 0x77, 0x4d, 0x77, 0x77, 0x68, 0x66,
        0x72, 0x2b, 0x48, 0x6b, 0x73, 0x54, 0x41, 0x51, 0x53, 0x51, 0x54, 0x36,
        0x65, 0x70, 0x57, 0x64, 0x77, 0x68, 0x33, 0x52, 0x68, 0x56, 0x2f, 0x33,
        0x39, 0x41, 0x61, 0x4a, 0x65, 0x4b, 0x0a, 0x39, 0x72, 0x4d, 0x66, 0x62,
        0x70, 0x71, 0x74, 0x59, 0x61, 0x53, 0x42, 0x6e, 0x43, 0x50, 0x44, 0x34,
        0x69, 0x55, 0x55, 0x78, 0x58, 0x34, 0x6c, 0x4c, 0x2b, 0x5a, 0x32, 0x36,
        0x45, 0x71, 0x57, 0x4d, 0x46, 0x69, 0x68, 0x46, 0x48, 0x59, 0x48, 0x6a,
        0x55, 0x56, 0x52, 0x4e, 0x42, 0x58, 0x52, 0x47, 0x74, 0x79, 0x67, 0x47,
        0x39, 0x6a, 0x63, 0x33, 0x64, 0x71, 0x4b, 0x50, 0x76, 0x6c, 0x4f, 0x0a,
        0x44, 0x75, 0x79, 0x6b, 0x6f, 0x6b, 0x75, 0x56, 0x75, 0x6d, 0x34, 0x44,
        0x35, 0x38, 0x78, 0x7a, 0x48, 0x58, 0x58, 0x55, 0x7a, 0x50, 0x46, 0x6e,
        0x58, 0x66, 0x63, 0x2b, 0x55, 0x4a, 0x67, 0x76, 0x76, 0x57, 0x57, 0x53,
        0x50, 0x46, 0x6e, 0x67, 0x65, 0x52, 0x4e, 0x32, 0x67, 0x30, 0x57, 0x43,
        0x34, 0x50, 0x76, 0x52, 0x39, 0x33, 0x55, 0x67, 0x2b, 0x47, 0x42, 0x36,
        0x79, 0x42, 0x38, 0x69, 0x0a, 0x79, 0x71, 0x50, 0x61, 0x6b, 0x59, 0x5a,
        0x6e, 0x50, 0x71, 0x55, 0x79, 0x5a, 0x74, 0x77, 0x6c, 0x55, 0x36, 0x58,
        0x58, 0x2f, 0x30, 0x52, 0x35, 0x4f, 0x6f, 0x4a, 0x4e, 0x49, 0x70, 0x51,
        0x6b, 0x76, 0x6b, 0x4d, 0x46, 0x55, 0x4e, 0x56, 0x78, 0x49, 0x68, 0x49,
        0x62, 0x4d, 0x39, 0x4e, 0x67, 0x36, 0x43, 0x63, 0x48, 0x69, 0x66, 0x71,
        0x6b, 0x38, 0x72, 0x68, 0x61, 0x74, 0x31, 0x4f, 0x42, 0x0a, 0x48, 0x64,
        0x32, 0x57, 0x54, 0x37, 0x32, 0x6e, 0x41, 0x67, 0x4d, 0x42, 0x41, 0x41,
        0x45, 0x43, 0x67, 0x67, 0x45, 0x42, 0x41, 0x4b, 0x31, 0x70, 0x6e, 0x67,
        0x30, 0x71, 0x4d, 0x39, 0x6f, 0x4d, 0x69, 0x65, 0x54, 0x67, 0x44, 0x56,
        0x67, 0x68, 0x2b, 0x5a, 0x39, 0x30, 0x42, 0x67, 0x32, 0x39, 0x50, 0x66,
        0x6c, 0x4b, 0x43, 0x56, 0x59, 0x62, 0x42, 0x43, 0x6f, 0x52, 0x75, 0x56,
        0x4f, 0x6c, 0x0a, 0x6c, 0x4b, 0x52, 0x67, 0x72, 0x2f, 0x74, 0x6e, 0x43,
        0x41, 0x72, 0x72, 0x48, 0x58, 0x74, 0x51, 0x6a, 0x66, 0x45, 0x4d, 0x6d,
        0x32, 0x7a, 0x4e, 0x41, 0x62, 0x39, 0x47, 0x5a, 0x38, 0x45, 0x39, 0x69,
        0x30, 0x32, 0x4e, 0x4d, 0x61, 0x6a, 0x78, 0x37, 0x56, 0x6d, 0x45, 0x46,
        0x33, 0x49, 0x57, 0x6f, 0x52, 0x48, 0x69, 0x58, 0x44, 0x63, 0x51, 0x62,
        0x41, 0x76, 0x43, 0x7a, 0x77, 0x37, 0x6c, 0x0a, 0x51, 0x46, 0x47, 0x74,
        0x58, 0x4c, 0x78, 0x58, 0x5a, 0x7a, 0x67, 0x69, 0x55, 0x41, 0x2f, 0x6e,
        0x6a, 0x42, 0x73, 0x69, 0x6c, 0x50, 0x54, 0x4e, 0x55, 0x7a, 0x6a, 0x42,
        0x51, 0x4d, 0x75, 0x34, 0x54, 0x71, 0x59, 0x73, 0x62, 0x7a, 0x31, 0x42,
        0x74, 0x78, 0x2f, 0x68, 0x67, 0x4d, 0x49, 0x54, 0x66, 0x50, 0x74, 0x32,
        0x41, 0x76, 0x39, 0x50, 0x66, 0x31, 0x4e, 0x4f, 0x55, 0x65, 0x43, 0x4b,
        0x0a, 0x63, 0x4a, 0x52, 0x36, 0x39, 0x47, 0x30, 0x65, 0x4c, 0x56, 0x47,
        0x49, 0x6d, 0x42, 0x56, 0x68, 0x4a, 0x6d, 0x4a, 0x78, 0x4c, 0x4d, 0x34,
        0x65, 0x35, 0x6c, 0x77, 0x73, 0x33, 0x52, 0x2b, 0x73, 0x59, 0x2f, 0x6f,
        0x36, 0x55, 0x6f, 0x72, 0x34, 0x48, 0x30, 0x30, 0x47, 0x43, 0x36, 0x65,
        0x66, 0x4e, 0x73, 0x5a, 0x49, 0x79, 0x4b, 0x59, 0x44, 0x42, 0x56, 0x5a,
        0x75, 0x48, 0x45, 0x47, 0x76, 0x0a, 0x6b, 0x4d, 0x55, 0x34, 0x41, 0x57,
        0x5a, 0x46, 0x48, 0x62, 0x43, 0x4f, 0x2f, 0x65, 0x48, 0x75, 0x38, 0x34,
        0x70, 0x63, 0x6e, 0x6a, 0x33, 0x4b, 0x58, 0x5a, 0x75, 0x55, 0x31, 0x6e,
        0x6c, 0x4a, 0x53, 0x6f, 0x71, 0x66, 0x66, 0x4f, 0x6e, 0x70, 0x32, 0x58,
        0x74, 0x55, 0x59, 0x58, 0x74, 0x72, 0x2b, 0x2b, 0x63, 0x7a, 0x48, 0x2f,
        0x59, 0x71, 0x59, 0x63, 0x2f, 0x4e, 0x68, 0x6f, 0x4f, 0x59, 0x0a, 0x44,
        0x70, 0x58, 0x59, 0x46, 0x4f, 0x6a, 0x39, 0x7a, 0x7a, 0x59, 0x58, 0x41,
        0x71, 0x45, 0x6e, 0x32, 0x65, 0x4a, 0x58, 0x46, 0x56, 0x65, 0x77, 0x72,
        0x76, 0x63, 0x52, 0x37, 0x69, 0x52, 0x76, 0x66, 0x43, 0x4a, 0x4b, 0x64,
        0x43, 0x31, 0x6b, 0x69, 0x50, 0x6b, 0x43, 0x67, 0x59, 0x45, 0x41, 0x2f,
        0x70, 0x79, 0x55, 0x66, 0x66, 0x30, 0x32, 0x67, 0x64, 0x6a, 0x66, 0x45,
        0x63, 0x55, 0x75, 0x0a, 0x74, 0x65, 0x51, 0x53, 0x63, 0x67, 0x31, 0x66,
        0x6d, 0x79, 0x55, 0x30, 0x4c, 0x38, 0x2f, 0x76, 0x55, 0x51, 0x2f, 0x4c,
        0x73, 0x39, 0x57, 0x77, 0x6a, 0x76, 0x4a, 0x4c, 0x50, 0x70, 0x31, 0x63,
        0x44, 0x6e, 0x33, 0x43, 0x52, 0x64, 0x46, 0x31, 0x42, 0x7a, 0x6c, 0x2f,
        0x34, 0x66, 0x65, 0x54, 0x48, 0x52, 0x73, 0x50, 0x64, 0x48, 0x45, 0x51,
        0x50, 0x50, 0x70, 0x63, 0x63, 0x6d, 0x78, 0x59, 0x0a, 0x48, 0x44, 0x47,
        0x37, 0x45, 0x59, 0x4e, 0x6e, 0x35, 0x38, 0x72, 0x6d, 0x70, 0x69, 0x79,
        0x76, 0x6e, 0x2f, 0x30, 0x32, 0x2b, 0x68, 0x46, 0x63, 0x78, 0x4f, 0x76,
        0x78, 0x55, 0x42, 0x36, 0x6d, 0x58, 0x78, 0x4b, 0x4c, 0x51, 0x62, 0x6e,
        0x79, 0x45, 0x76, 0x4a, 0x32, 0x72, 0x64, 0x72, 0x69, 0x4a, 0x56, 0x66,
        0x6d, 0x58, 0x61, 0x7a, 0x49, 0x75, 0x6a, 0x39, 0x4b, 0x4a, 0x48, 0x36,
        0x72, 0x0a, 0x38, 0x59, 0x34, 0x2f, 0x48, 0x68, 0x4d, 0x44, 0x76, 0x6d,
        0x61, 0x34, 0x54, 0x76, 0x4f, 0x47, 0x71, 0x53, 0x67, 0x50, 0x55, 0x4b,
        0x56, 0x70, 0x32, 0x41, 0x73, 0x43, 0x67, 0x59, 0x45, 0x41, 0x36, 0x4d,
        0x42, 0x43, 0x48, 0x58, 0x54, 0x77, 0x6a, 0x52, 0x38, 0x6a, 0x43, 0x57,
        0x6a, 0x68, 0x54, 0x44, 0x4a, 0x69, 0x37, 0x52, 0x30, 0x59, 0x59, 0x47,
        0x33, 0x65, 0x49, 0x4a, 0x48, 0x70, 0x0a, 0x70, 0x52, 0x63, 0x72, 0x4e,
        0x31, 0x49, 0x64, 0x48, 0x39, 0x4e, 0x61, 0x53, 0x45, 0x70, 0x67, 0x34,
        0x31, 0x2f, 0x4d, 0x74, 0x63, 0x34, 0x41, 0x68, 0x52, 0x6e, 0x73, 0x35,
        0x68, 0x65, 0x72, 0x76, 0x6f, 0x70, 0x54, 0x31, 0x59, 0x33, 0x7a, 0x75,
        0x44, 0x58, 0x38, 0x78, 0x46, 0x4e, 0x70, 0x49, 0x47, 0x6f, 0x57, 0x63,
        0x4f, 0x69, 0x6b, 0x66, 0x46, 0x70, 0x75, 0x62, 0x63, 0x43, 0x4a, 0x0a,
        0x63, 0x35, 0x4f, 0x57, 0x38, 0x32, 0x45, 0x76, 0x68, 0x68, 0x46, 0x73,
        0x76, 0x2f, 0x30, 0x57, 0x65, 0x4e, 0x56, 0x48, 0x62, 0x5a, 0x33, 0x52,
        0x56, 0x52, 0x35, 0x72, 0x45, 0x61, 0x78, 0x45, 0x35, 0x54, 0x67, 0x68,
        0x68, 0x6a, 0x4c, 0x61, 0x6f, 0x4d, 0x47, 0x67, 0x2f, 0x46, 0x64, 0x5a,
        0x58, 0x71, 0x44, 0x4b, 0x52, 0x65, 0x6d, 0x57, 0x39, 0x46, 0x55, 0x31,
        0x58, 0x35, 0x2f, 0x4d, 0x0a, 0x6f, 0x6f, 0x38, 0x4c, 0x49, 0x4b, 0x4a,
        0x49, 0x52, 0x6c, 0x55, 0x43, 0x67, 0x59, 0x45, 0x41, 0x33, 0x53, 0x39,
        0x66, 0x58, 0x48, 0x66, 0x74, 0x73, 0x79, 0x32, 0x59, 0x30, 0x39, 0x49,
        0x74, 0x65, 0x76, 0x77, 0x50, 0x2f, 0x68, 0x36, 0x61, 0x45, 0x4b, 0x68,
        0x6f, 0x52, 0x71, 0x54, 0x6e, 0x37, 0x4d, 0x37, 0x42, 0x45, 0x70, 0x41,
        0x76, 0x32, 0x6d, 0x36, 0x6f, 0x61, 0x56, 0x50, 0x41, 0x0a, 0x6c, 0x69,
        0x49, 0x76, 0x39, 0x41, 0x45, 0x37, 0x48, 0x6a, 0x53, 0x59, 0x59, 0x4e,
        0x42, 0x33, 0x62, 0x39, 0x43, 0x44, 0x51, 0x34, 0x2b, 0x35, 0x49, 0x4a,
        0x41, 0x4b, 0x59, 0x61, 0x69, 0x33, 0x66, 0x6e, 0x37, 0x42, 0x57, 0x54,
        0x79, 0x44, 0x74, 0x6e, 0x79, 0x77, 0x6c, 0x47, 0x6d, 0x37, 0x68, 0x45,
        0x77, 0x77, 0x52, 0x31, 0x74, 0x76, 0x38, 0x4f, 0x35, 0x62, 0x61, 0x31,
        0x50, 0x46, 0x0a, 0x43, 0x6c, 0x43, 0x4d, 0x77, 0x32, 0x4e, 0x71, 0x35,
        0x59, 0x54, 0x58, 0x44, 0x72, 0x39, 0x59, 0x75, 0x45, 0x49, 0x39, 0x4d,
        0x4f, 0x47, 0x61, 0x57, 0x78, 0x6f, 0x43, 0x4b, 0x65, 0x51, 0x56, 0x4d,
        0x54, 0x70, 0x32, 0x6f, 0x49, 0x53, 0x36, 0x4f, 0x74, 0x7a, 0x33, 0x66,
        0x6a, 0x62, 0x57, 0x6f, 0x2f, 0x72, 0x57, 0x47, 0x79, 0x51, 0x6e, 0x35,
        0x2f, 0x4d, 0x43, 0x67, 0x59, 0x42, 0x2b, 0x0a, 0x33, 0x56, 0x79, 0x73,
        0x52, 0x62, 0x4e, 0x67, 0x6d, 0x4a, 0x6f, 0x32, 0x5a, 0x4d, 0x35, 0x35,
        0x41, 0x2f, 0x58, 0x63, 0x48, 0x4d, 0x48, 0x4f, 0x76, 0x64, 0x51, 0x58,
        0x6d, 0x4c, 0x44, 0x72, 0x35, 0x61, 0x63, 0x4f, 0x72, 0x6c, 0x6c, 0x6c,
        0x6f, 0x59, 0x52, 0x53, 0x5a, 0x77, 0x68, 0x4d, 0x70, 0x30, 0x6b, 0x6a,
        0x78, 0x37, 0x65, 0x4d, 0x31, 0x55, 0x62, 0x46, 0x58, 0x42, 0x32, 0x6d,
        0x0a, 0x37, 0x43, 0x73, 0x70, 0x2b, 0x67, 0x66, 0x67, 0x58, 0x72, 0x7a,
        0x36, 0x48, 0x69, 0x54, 0x74, 0x49, 0x43, 0x59, 0x2f, 0x51, 0x4f, 0x39,
        0x33, 0x51, 0x4b, 0x74, 0x30, 0x63, 0x7a, 0x2f, 0x34, 0x6d, 0x58, 0x66,
        0x73, 0x44, 0x51, 0x73, 0x6b, 0x58, 0x70, 0x63, 0x53, 0x52, 0x74, 0x64,
        0x61, 0x34, 0x5a, 0x58, 0x66, 0x62, 0x2b, 0x68, 0x4d, 0x4a, 0x78, 0x70,
        0x68, 0x4e, 0x61, 0x38, 0x50, 0x0a, 0x36, 0x66, 0x71, 0x4c, 0x39, 0x57,
        0x67, 0x70, 0x75, 0x36, 0x45, 0x4f, 0x4b, 0x6d, 0x5a, 0x79, 0x4a, 0x39,
        0x35, 0x5a, 0x49, 0x53, 0x76, 0x41, 0x33, 0x6a, 0x6b, 0x4c, 0x65, 0x45,
        0x54, 0x49, 0x54, 0x6f, 0x50, 0x59, 0x4d, 0x39, 0x79, 0x46, 0x53, 0x51,
        0x4b, 0x42, 0x67, 0x45, 0x57, 0x48, 0x4c, 0x4b, 0x2f, 0x5a, 0x57, 0x5a,
        0x37, 0x47, 0x6d, 0x4a, 0x39, 0x4d, 0x4d, 0x34, 0x48, 0x5a, 0x0a, 0x38,
        0x36, 0x33, 0x31, 0x63, 0x70, 0x45, 0x6f, 0x72, 0x62, 0x4a, 0x71, 0x58,
        0x33, 0x7a, 0x4f, 0x58, 0x6f, 0x47, 0x34, 0x58, 0x48, 0x45, 0x69, 0x34,
        0x51, 0x62, 0x62, 0x57, 0x51, 0x43, 0x77, 0x4a, 0x4b, 0x4a, 0x68, 0x34,
        0x79, 0x33, 0x37, 0x6d, 0x31, 0x31, 0x33, 0x4c, 0x66, 0x71, 0x32, 0x36,
        0x65, 0x72, 0x35, 0x75, 0x38, 0x61, 0x68, 0x37, 0x79, 0x45, 0x30, 0x62,
        0x4f, 0x34, 0x47, 0x0a, 0x66, 0x57, 0x37, 0x37, 0x6b, 0x54, 0x73, 0x44,
        0x44, 0x68, 0x72, 0x61, 0x37, 0x58, 0x55, 0x36, 0x6b, 0x51, 0x57, 0x76,
        0x41, 0x4a, 0x5a, 0x71, 0x63, 0x45, 0x36, 0x57, 0x44, 0x51, 0x75, 0x32,
        0x41, 0x77, 0x61, 0x38, 0x62, 0x47, 0x6f, 0x32, 0x33, 0x2f, 0x54, 0x34,
        0x38, 0x77, 0x48, 0x47, 0x66, 0x58, 0x74, 0x57, 0x4d, 0x43, 0x2b, 0x43,
        0x54, 0x63, 0x2b, 0x68, 0x2f, 0x31, 0x73, 0x54, 0x0a, 0x33, 0x47, 0x53,
        0x6e, 0x7a, 0x77, 0x55, 0x76, 0x52, 0x77, 0x31, 0x52, 0x2f, 0x46, 0x53,
        0x43, 0x4c, 0x47, 0x76, 0x75, 0x53, 0x52, 0x38, 0x70, 0x0a, 0x2d, 0x2d,
        0x2d, 0x2d, 0x2d, 0x45, 0x4e, 0x44, 0x20, 0x50, 0x52, 0x49, 0x56, 0x41,
        0x54, 0x45, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x00
};


void setPin() {
//  Pushbutton
    pinMode(trigger_drillBitControl, INPUT_PULLUP);
    pinMode(rotationDirectionControl, INPUT_PULLUP);

//  Rotary Switch
    pinMode(airRegulator_0, INPUT_PULLUP);
    pinMode(airRegulator_1, INPUT_PULLUP);
    pinMode(airRegulator_2, INPUT_PULLUP);
    pinMode(airRegulator_3, INPUT_PULLUP);

//  Output
    pinMode(led, OUTPUT);
    pinMode(motor, OUTPUT);

    // Turn off the led & motor
    digitalWrite(led, ledValue);
    digitalWrite(motor, initialMotorValue);
}


void setWIFI(bool useEAP) {

    if (useEAP) {
        ssid = "wpa.mcgill.ca";
        pass = "ivlxndaqc123";
    } else {
        ssid = "srl-mini";
        pass = "sre_lab_mcgill";
    }

    Serial.begin(115200);
    delay(100);
    Serial.println();
    Serial.println();
    Serial.print("Connecting to ");
    Serial.println(ssid);
    if (useEAP) {
        WiFi.mode(WIFI_STA);
        wifi_station_set_username(identity, sizeof(identity));
        while (wifi_station_set_cert_key(espclientCrt, sizeof(espclientCrt),
                                         espclientKey, sizeof(espclientKey), NULL, 0)) {
            Serial.println("Set cert key unsuccessful!");
        }
        Serial.println("Set cert key successful!");

    }

    WiFi.begin(ssid, pass);

    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.print(".");
    }

    Serial.println("\n");
    Serial.println("WiFi connected");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
}

void setServer() {

    Serial.begin(115200);

    // Connect to WiFi network
    setWIFI(useEAPInit);

    // Start the server
    server.begin();

    // Start UDP
    Udp.begin(OSCLocalPort);
    Serial.println("Server & UDP started");
    Serial.print("Local port: ");
    Serial.println(Udp.localPort());
    Serial.println();

    // Set OSC IP
    OSCIP.toCharArray(OSCIP_char, OSCIP.length() + 1);

}

void sendOSCMsg(String msgString) {
    Serial.println("msg sent: " + msgString + ".");

    // Send OSC message
    OSCMessage msg(addressPattern);


    msgString.toCharArray(msgChar, msgString.length() + 1);
    msg.add(msgChar);

    OSCIP.toCharArray(OSCIP_char, OSCIP.length() + 1);
//  Serial.print("\nOSCIP_char is: ");
//  Serial.println(OSCIP_char);

    Udp.beginPacket(OSCIP_char, OSCRemotePort);
    msg.send(Udp);
    Udp.endPacket();
    msg.empty();
    delay(100);
}

void turnOnLed() {
    ledValue = 0;
    digitalWrite(led, ledValue);
}

void setup() {

    setPin();
    setServer();

    turnOnLed();
}


bool buttonPressed(int buttonIndex) {
    if (!digitalRead(buttonIndex))
        return true;
    else
        return false;
}

void changeAirIntensity() {
    airIntensity = (airIntensity + 1) % airIntensityLevelNum;
}

void changeAirIntensity(int level) {
    airIntensity = level;
}

void changeRotationDirection() {
    rotationDirection = (rotationDirection + 1) % rotationDirectionNum;
}

void changeRotationDirection(int level) {
    rotationDirection = level;
}

void motorControl(bool control) {
    if (control) {
        analogWrite(motor, pwmValue[airIntensity]);
    } else {
        analogWrite(motor, 0);
    }
}


bool trigger_DrillBitControlBool = false;

void sendTrigger_DrillBitControl() {
    if (buttonPressed(trigger_drillBitControl)) {
        sendOSCMsg("p");
        trigger_DrillBitControlBool = true;

        motorControl(true);

        return;
    }
    if (trigger_DrillBitControlBool) {
        sendOSCMsg("pp");
        trigger_DrillBitControlBool = false;

        motorControl(false);
    }
}


// Control rotation trigger
int lastRotationDirection = -1;

void sendrotationDirectionControl() {
    if (buttonPressed(rotationDirectionControl)) {
        changeRotationDirection(0);
    } else {
        changeRotationDirection(1);
    }
    if (lastRotationDirection != rotationDirection) {
        lastRotationDirection = rotationDirection;
        sendOSCMsg("r" + String(rotationDirection));
        Serial.printf("The current rotationDirection is: %d.\n", rotationDirection);
    }
}

// Control air intensity
int lastAirIntensity = -1;

void sendAirRegulatorControl() {
//  Serial.printf("Checking airIntensity.\n");
    if (buttonPressed(airRegulator_0)) {
        changeAirIntensity(0);
    } else if (buttonPressed(airRegulator_1)) {
        changeAirIntensity(1);
    } else if (buttonPressed(airRegulator_2)) {
        changeAirIntensity(2);
    } else if (buttonPressed(airRegulator_3)) {
        changeAirIntensity(3);
    }

    if (lastAirIntensity != airIntensity) {
        lastAirIntensity = airIntensity;
        Serial.printf("The current airIntensity is: %d.\n", airIntensity);
        sendOSCMsg("a" + String(airIntensity));
    }
}


void OSCControl() {

    sendAirRegulatorControl();
    sendrotationDirectionControl();
    sendTrigger_DrillBitControl();

}


String processRequest(WiFiClient &client) {

    String req = client.readStringUntil('\r');
    String output = "";
    Serial.println("\n");
    Serial.println("req: " + req);
    client.flush();

    // Match the request
    if (req.indexOf(requests[0]) != -1) {
        String currentCommand = "setLedValue";

        int firstPos = req.indexOf(currentCommand);
        int secondPos = req.indexOf(currentCommand, firstPos + 1);

        String ledValue_string = req.substring(firstPos + currentCommand.length() + 1, secondPos - 1);
        ledValue = ledValue_string.toInt();


        // Set ledValue according to the request
        digitalWrite(led, ledValue);

        Serial.println("ledValue is: " + ledValue_string);
        output = "Set ledValue = " + ledValue_string;
    } else if (req.indexOf(requests[1]) != -1) {
        String currentCommand = "setOSCIP";

        int firstPos = req.indexOf(currentCommand);
        int secondPos = req.indexOf(currentCommand, firstPos + 1);

        OSCIP = req.substring(firstPos + currentCommand.length() + 1, secondPos - 1);

        Serial.println("New OSC IP is: " + OSCIP);
        output = "Set OSC IP to " + OSCIP;
    } else if (req.indexOf(requests[2]) != -1) {
        String currentCommand = "setOSCRemotePort";

        int firstPos = req.indexOf(currentCommand);
        int secondPos = req.indexOf(currentCommand, firstPos + 1);

        String OSCRemotePort_string = req.substring(firstPos + currentCommand.length() + 1, secondPos - 1);
        OSCRemotePort = OSCRemotePort_string.toInt();

        Serial.println("New OSC remote port is: " + OSCRemotePort);
        output = "Set OSC remote port to " + OSCRemotePort_string;
    } else if (req.indexOf(requests[3]) != -1) {
        String currentCommand = "setOSCLocalPort";

        int firstPos = req.indexOf(currentCommand);
        int secondPos = req.indexOf(currentCommand, firstPos + 1);

        String OSCLocalPort_string = req.substring(firstPos + currentCommand.length() + 1, secondPos - 1);
        OSCLocalPort = OSCLocalPort_string.toInt();

        Serial.println("New OSC local port is: " + OSCLocalPort);
        output = "Set OSC local port to" + OSCLocalPort_string;
    } else if (req.indexOf(requests[4]) != -1) {

        output = "The overall setting is:" + String("\n")
                 + "LedValue is: " + String(ledValue) + "\n"
                 + "OSCIP is: " + String(OSCIP) + "\n"
                 + "OSCRemotePort is: " + String(OSCRemotePort) + "\n"
                 + "OSCLocalPort is: " + String(OSCLocalPort) + "\n";

    }else if (req.indexOf(requests[5]) != -1) {

        setWIFI(true);
        Serial.println("Reconnecting to McGill Wifi");

    }else if (req.indexOf(requests[5]) != -1) {

        setWIFI(false);
        Serial.println("Reconnecting to srl Wifi");

    } else {
//    Serial.println("invalid request");

//    return;
    }



    return output;

}


void loop() {

    // Confirm WIFI connection
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("Reconnecting WIFI.");
    }
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }

    // Control Moverio through OSC
    OSCControl();


    // Build a webserver allowing parameter setting
    // Check if a client has connected
    WiFiClient client = server.available();
    if (!client) {
        return;
    }

    // Wait until the client sends some data
    Serial.println("new client");
//  while(!client.available()){
//    delay(1);
//  }

    // Process the request of the client
    String output = processRequest(client);


    client.flush();

    // Prepare the response
//  String s = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n<!DOCTYPE HTML>\r\n<html>\r\nGPIO is now ";
//  s += (val)?"high":"low";
//  s += "</html>\n";

    // Send the response to the client
//  client.print(s);
    client.println(output);
    delay(1);
    Serial.println("Client disonnected");

    // The client will actually be disconnected
    // when the function returns and 'client' object is detroyed
    client.stop();
}

